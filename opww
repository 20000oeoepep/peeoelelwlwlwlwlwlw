<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø£Ù†Ù…ÙŠ Ø¨Ø§ÙˆØ± | Anime Power</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <style>
        :root {
            --primary: #229ED9;
            --bg-dark: #0a0b10;
            --glass: rgba(255, 255, 255, 0.05);
            --shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.8);
        }

        body { margin: 0; background: var(--bg-dark); color: #fff; font-family: 'Cairo', sans-serif; overflow: hidden; }
        #bg-canvas { position: fixed; top: 0; left: 0; z-index: 1; }

        /* Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 100;
            background: radial-gradient(circle at center, #1a1c25 0%, #000 100%);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: 0.5s;
        }
        
        .login-card {
            background: var(--glass); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1);
            padding: 30px; border-radius: 20px; box-shadow: var(--shadow); width: 320px; text-align: center;
        }

        .taka-input, .taka-select {
            background: rgba(0,0,0,0.5); border: 1px solid var(--primary);
            color: white; padding: 12px; width: 100%; border-radius: 10px; margin: 10px 0;
            font-family: 'Cairo'; font-size: 14px; outline: none; transition: 0.3s; box-sizing: border-box;
        }
        .taka-input:focus { border-color: #fff; box-shadow: 0 0 10px var(--primary); }
        
        .taka-btn {
            background: var(--primary); color: #000; border: none; padding: 12px; width: 100%;
            font-weight: bold; cursor: pointer; border-radius: 10px; font-size: 16px;
            margin-top: 10px; font-family: 'Cairo'; transition: 0.3s;
        }
        .taka-btn:hover { background: #fff; transform: translateY(-2px); box-shadow: 0 5px 15px var(--primary); }
        .admin-link { font-size: 12px; color: #666; cursor: pointer; margin-top: 15px; display: block; text-decoration: underline; }

        /* Ø´Ø§Ø´Ø© Ø§Ù„Ø´Ø§Øª */
        #chat-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 50;
            display: none; flex-direction: column; background: rgba(0,0,0,0.3);
        }

        .header {
            padding: 15px 20px; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(34, 158, 217, 0.3); display: flex; justify-content: space-between; align-items: center;
        }
        
        #messages-list { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; scroll-behavior: smooth; }

        /* Ø³ØªØ§ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ */
        .msg {
            max-width: 85%; padding: 12px 18px; border-radius: 15px; position: relative;
            animation: fadeIn 0.3s ease; line-height: 1.6; border: 1px solid rgba(255,255,255,0.05);
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .msg.mine { align-self: flex-start; background: linear-gradient(135deg, #229ED9, #166d96); color: white; border-bottom-right-radius: 2px; }
        .msg.theirs { align-self: flex-end; background: rgba(40,40,40,0.8); border-bottom-left-radius: 2px; }
        
        .msg-info { font-size: 11px; margin-bottom: 5px; display: flex; gap: 8px; align-items: center; }
        .badge { padding: 2px 8px; border-radius: 4px; font-size: 9px; font-weight: bold; background: rgba(255,255,255,0.2); }
        .badge.admin { background: #ff4757; color: #fff; }
        .badge.team { background: #2f3542; color: var(--primary); border: 1px solid var(--primary); }

        .admin-tools { margin-top: 8px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 5px; display: flex; gap: 10px; }
        .del-btn { color: #ff4757; font-size: 11px; cursor: pointer; }

        .input-area { padding: 20px; background: rgba(0,0,0,0.8); display: flex; gap: 10px; backdrop-filter: blur(10px); }

        .status-dot { width: 10px; height: 10px; border-radius: 50%; background: #ff4757; display: inline-block; margin-left: 5px; }
        .status-dot.online { background: #2ed573; box-shadow: 0 0 10px #2ed573; }

    </style>
</head>
<body>

    <div id="bg-canvas"></div>

    <div id="login-screen">
        <div class="login-card">
            <h2 style="color:var(--primary); margin-bottom:5px;">Ø£Ù†Ù…ÙŠ Ø¨Ø§ÙˆØ±</h2>
            <p style="color:#aaa; font-size:13px; margin-bottom:20px;">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø¯ÙŠØ³ÙƒÙˆØ±Ø¯ Ø£Ù†Ù…ÙŠ Ø¨Ø§ÙˆØ±</p>
            
            <input type="text" id="username" class="taka-input" placeholder="Ø§Ø³Ù…Ùƒ Ø§Ù„Ù…Ø³ØªØ¹Ø§Ø±">
            
            <select id="team-select" class="taka-select">
                <option value="Ø§Ù„ØªØ§ÙƒØ§">ÙØ±Ù‚Ø© Ø§Ù„ØªØ§ÙƒØ§</option>
                <option value="Ø³ØªÙˆØ±Ù…">ÙØ±Ù‚Ø© Ø³ØªÙˆØ±Ù…</option>
                <option value="Ø§Ù„ØºÙŠÙ„Ø§Ù†">ÙØ±Ù‚Ø© Ø§Ù„ØºÙŠÙ„Ø§Ù†</option>
                <option value="Ø§Ù„Ø§Ø³ØªØ·Ù„Ø§Ø¹">ÙØ±Ù‚Ø© Ø§Ù„Ø§Ø³ØªØ·Ù„Ø§Ø¹</option>
                <option value="Ø±ÙŠÙˆØ¯Ø§Ù†">ÙØ±Ù‚Ø© Ø±ÙŠÙˆØ¯Ø§Ù†</option>
                <option value="ÙƒÙˆØ±Ø³ÙŠØ¯">ÙØ±Ù‚Ø© ÙƒÙˆØ±Ø³ÙŠØ¯</option>
                <option value="Ø£Ø®Ø±Ù‰">ÙØ±Ù‚Ø© Ø£Ø®Ø±Ù‰</option>
            </select>
            
            <button class="taka-btn" onclick="connectToAnimePower()">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù‚Ù†Ø§Ø©</button>
            <span class="admin-link" onclick="checkAdmin()">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£Ø´Ø±Ø§Ù</span>
        </div>
    </div>

    <div id="chat-screen">
        <div class="header">
            <div>
                <b style="color:var(--primary); font-size:18px;">Ø¯ÙŠØ³ÙƒÙˆØ±Ø¯ Ø£Ù†Ù…ÙŠ Ø¨Ø§ÙˆØ±</b>
                <div style="font-size:11px; color:#888" id="user-info-display">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
            </div>
            <div style="font-size: 12px;">
                <span id="status-dot" class="status-dot"></span>
                <span id="status-text">Ø£ÙˆÙÙ„Ø§ÙŠÙ†</span>
            </div>
        </div>

        <div id="messages-list"></div>

        <div class="input-area">
            <input type="text" id="msg-input" class="taka-input" style="margin:0;" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§..." onkeypress="if(event.key==='Enter') sendMsg()">
            <button class="taka-btn" style="width:70px; margin:0;" onclick="sendMsg()">Ø¥Ø±Ø³Ø§Ù„</button>
        </div>
    </div>

    <script>
        // ==========================================
        // 1. Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ù…ØªØºÙŠØ±Ø§Øª
        // ==========================================
        const BROKER = "broker.emqx.io";
        const PORT = 8084;
        const CLIENT_ID = "ap_" + Math.random().toString(16).substr(2, 8);
        const ADMIN_PASS = "123456pooqos5#09wowbo";
        const ROOM = "anime_power_main_v1";

        let client;
        let userData = {
            name: localStorage.getItem('ap_name') || "",
            team: localStorage.getItem('ap_team') || "Ø§Ù„ØªØ§ÙƒØ§",
            isAdmin: localStorage.getItem('ap_isAdmin') === 'true'
        };
        let isConnected = false;
        let localHistory = [];

        // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
        if(userData.name) {
            document.getElementById('username').value = userData.name;
            document.getElementById('team-select').value = userData.team;
        }

        // ==========================================
        // 2. Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¥Ø´Ø±Ø§Ù ÙˆØ§Ù„Ø¯Ø®ÙˆÙ„
        // ==========================================
        function checkAdmin() {
            const pass = prompt("Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø³Ø± Ø§Ù„Ø£Ø´Ø±Ø§Ù:");
            if(pass === ADMIN_PASS) {
                userData.isAdmin = true;
                localStorage.setItem('ap_isAdmin', 'true');
                alert("ØªÙ… ØªÙØ¹ÙŠÙ„ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­ ğŸ›¡ï¸");
            } else {
                alert("ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø®Ø§Ø·Ø¦Ø©!");
            }
        }

        function connectToAnimePower() {
            const name = document.getElementById('username').value.trim();
            const team = document.getElementById('team-select').value;
            
            if(!name) return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù…Ùƒ!");

            userData.name = name;
            userData.team = team;
            
            // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            localStorage.setItem('ap_name', name);
            localStorage.setItem('ap_team', team);

            document.getElementById('login-screen').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('chat-screen').style.display = 'flex';
                document.getElementById('user-info-display').innerText = `${userData.name} | ÙØ±Ù‚Ø© ${userData.team} ${userData.isAdmin ? '(Ù…Ø³Ø¤ÙˆÙ„)' : ''}`;
            }, 500);

            startMQTT();
        }

        // ==========================================
        // 3. Ù…Ø­Ø±Ùƒ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ (MQTT)
        // ==========================================
        function startMQTT() {
            client = new Paho.MQTT.Client(BROKER, PORT, CLIENT_ID);
            client.onConnectionLost = (e) => { setStatus(false); };
            client.onMessageArrived = onMessageArrived;

            client.connect({
                useSSL: true,
                onSuccess: () => {
                    setStatus(true);
                    isConnected = true;
                    client.subscribe(ROOM);
                    // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…
                    publishData("JOIN", { name: userData.name, team: userData.team });
                    publishData("SYNC_REQ", {});
                }
            });
        }

        function sendMsg() {
            const inp = document.getElementById('msg-input');
            if(!inp.value.trim() || !isConnected) return;

            const msg = {
                id: Date.now() + Math.random(),
                user: userData.name,
                team: userData.team,
                text: inp.value.trim(),
                isAdmin: userData.isAdmin,
                time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
            };

            publishData("MSG", msg);
            inp.value = "";
        }

        function publishData(type, content) {
            const payload = JSON.stringify({ type, data: content, sender: CLIENT_ID });
            const message = new Paho.MQTT.Message(payload);
            message.destinationName = ROOM;
            client.send(message);
        }

        function onMessageArrived(message) {
            const packet = JSON.parse(message.payloadString);
            const isMe = packet.sender === CLIENT_ID;

            if(packet.type === "MSG") {
                displayMessage(packet.data, isMe);
                saveHistory(packet.data);
            } else if(packet.type === "JOIN" && !isMe) {
                addSystemMsg(`ØªÙ… Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…: ${packet.data.name} - ÙØ±Ù‚Ø© ${packet.data.team}`);
            } else if(packet.type === "DELETE" && userData.isAdmin) {
                // Ù…Ù†Ø·Ù‚ Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ù† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© (Ø¨Ø³ÙŠØ·)
                const element = document.getElementById(packet.data.msgId);
                if(element) element.remove();
            }
            // Ù…Ù†Ø·Ù‚ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù…Ø¨Ø³Ø·
            else if(packet.type === "SYNC_REQ" && !isMe && localHistory.length > 0) {
                setTimeout(() => publishData("SYNC_RES", localHistory), 1000);
            }
            else if(packet.type === "SYNC_RES" && !isMe && localHistory.length === 0) {
                packet.data.forEach(m => {
                    if(!localHistory.find(x => x.id === m.id)) {
                        displayMessage(m, false);
                        saveHistory(m);
                    }
                });
            }
        }

        // ==========================================
        // 4. Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø±Ø³ÙˆÙ…ÙŠØ©
        // ==========================================
        function displayMessage(msg, isMine) {
            if(document.getElementById(msg.id)) return;

            const list = document.getElementById('messages-list');
            const div = document.createElement('div');
            div.className = `msg ${isMine ? 'mine' : 'theirs'}`;
            div.id = msg.id;
            
            div.innerHTML = `
                <div class="msg-info">
                    <span style="font-weight:bold">${msg.user}</span>
                    <span class="badge team">${msg.team}</span>
                    ${msg.isAdmin ? '<span class="badge admin">Ù…Ø³Ø¤ÙˆÙ„</span>' : ''}
                    <span style="opacity:0.5">${msg.time}</span>
                </div>
                <div>${msg.text}</div>
                ${userData.isAdmin ? `
                    <div class="admin-tools">
                        <span class="del-btn" onclick="deleteRemote('${msg.id}')">Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø©</span>
                    </div>
                ` : ''}
            `;
            
            list.appendChild(div);
            list.scrollTop = list.scrollHeight;
        }

        function deleteRemote(id) {
            if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø¬Ù…ÙŠØ¹ØŸ")) {
                publishData("DELETE", { msgId: id });
                const el = document.getElementById(id);
                if(el) el.remove();
            }
        }

        function addSystemMsg(txt) {
            const list = document.getElementById('messages-list');
            const div = document.createElement('div');
            div.style = "text-align:center; font-size:11px; color:var(--primary); opacity:0.7; margin:10px 0";
            div.innerText = "âœ¨ " + txt;
            list.appendChild(div);
            list.scrollTop = list.scrollHeight;
        }

        function setStatus(online) {
            const dot = document.getElementById('status-dot');
            const txt = document.getElementById('status-text');
            dot.className = online ? "status-dot online" : "status-dot";
            txt.innerText = online ? "Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø´Ø¨ÙƒØ©" : "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...";
        }

        function saveHistory(msg) {
            localHistory.push(msg);
            if(localHistory.length > 30) localHistory.shift();
        }

        // ==========================================
        // 5. Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø£Ù†ÙŠÙ…ÙŠØ´Ù† (Three.js)
        // ==========================================
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.getElementById('bg-canvas').appendChild(renderer.domElement);

        const particlesGeometry = new THREE.BufferGeometry();
        const count = 100;
        const positions = new Float32Array(count * 3);
        for(let i=0; i<count*3; i++) positions[i] = (Math.random() - 0.5) * 100;
        particlesGeometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));

        const material = new THREE.PointsMaterial({ color: 0x229ED9, size: 0.5, transparent: true, opacity: 0.5 });
        const points = new THREE.Points(particlesGeometry, material);
        scene.add(points);

        camera.position.z = 50;

        function animate() {
            requestAnimationFrame(animate);
            points.rotation.y += 0.001;
            points.rotation.x += 0.0005;
            renderer.render(scene, camera);
        }
        animate();

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

    </script>
</body>
</html>
